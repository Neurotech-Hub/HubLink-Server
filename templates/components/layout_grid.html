<div class="grid-stack">
    {% for item in layout.config %}
        {% set plot_id = item.plotId | int %}
        {% set plot = plot_info_arr | selectattr("plot_id", "equalto", plot_id) | first %}

        {% if plot %}
            <div class="grid-stack-item" 
                 gs-x="{{ item.x }}" 
                 gs-y="{{ item.y }}" 
                 gs-w="{{ item.w }}" 
                 gs-h="1" 
                 gs-no-resize="true" 
                 gs-no-move="true">
                <div class="grid-stack-item-content">
                    <div class="plot-container" id="plot-{{ plot_id }}-{{ loop.index0 }}"></div>
                </div>
            </div>
            <script>
                (function() {
                    const plotDiv = document.getElementById('plot-{{ plot_id }}-{{ loop.index0 }}');
                    const plotData = {{ plot.plotly_json | safe }};
                    
                    if (!plotDiv) {
                        console.error('Plot container not found for plot {{ plot_id }}');
                        return;
                    }
                    
                    if (!plotData) {
                        console.error('No plot data for plot {{ plot_id }}');
                        return;
                    }
                    
                    try {
                        Plotly.newPlot(
                            plotDiv,
                            plotData.data,
                            plotData.layout,
                            {
                                responsive: true,
                                displayModeBar: 'hover',
                                displaylogo: false,
                                modeBarButtonsToRemove: ['select2d', 'lasso2d', 'autoScale2d']
                            }
                        ).catch(err => {
                            console.error('Error plotting:', err);
                        });
                    } catch (err) {
                        console.error('Error initializing plot:', err);
                    }
                })();
            </script>
        {% endif %}
    {% endfor %}
</div> 