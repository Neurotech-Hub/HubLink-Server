{% extends "base.html" %}

{% block head %}
<!-- Only load GridStack when in edit mode -->
<link href="https://cdn.jsdelivr.net/npm/gridstack@8.2.1/dist/gridstack.min.css" rel="stylesheet" class="edit-only d-none"/>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col">
            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h2>{{ layout.name }}</h2>
                    
                    <!-- Mode Toggle -->
                    <div class="toggle-container">
                        <div class="toggle-switch">
                            <div class="switch-label left">View</div>
                            <div class="switch-label right">Edit</div>
                            <div class="switch-handle"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Edit Mode Controls -->
            <div id="editControls" class="d-none">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-secondary" onclick="addWidget('full')">
                            <i class="fa fa-plus"></i> Full Width
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="addWidget('half')">
                            <i class="fa fa-plus"></i> Half Width
                        </button>
                    </div>
                    <button class="btn btn-sm btn-primary" onclick="saveLayout()">Save Layout</button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Mode Container -->
    <div id="viewContainer">
        <div class="row" id="plotContainer">
            <!-- Plots will be dynamically inserted here -->
        </div>
    </div>

    <!-- Edit Mode Container -->
    <div id="editContainer" class="layout-container d-none">
        <div class="grid-stack"></div>
    </div>
</div>

<!-- Template for plot selection -->
<template id="widget-template">
    <div class="widget-container">
        <button class="btn btn-sm remove-widget" type="button">
            <i class="fa fa-times"></i>
        </button>
        <select class="form-select plot-selector" onchange="plotSelected(this)">
            <option value="">Select a plot...</option>
            {% for plot in plots %}
            <option value="{{ plot.id }}">{{ plot.name }}</option>
            {% endfor %}
        </select>
    </div>
</template>

<!-- Plotly.js -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gridstack@8.2.1/dist/gridstack-all.js"></script>

<script>
    let grid;
    let isEditMode = false;
    
    document.addEventListener('DOMContentLoaded', function() {
        loadViewMode();
        
        const toggleSwitch = document.querySelector('.toggle-switch');
        toggleSwitch.addEventListener('click', function() {
            this.classList.toggle('active');
            isEditMode = this.classList.contains('active');
            
            document.getElementById('editControls').classList.toggle('d-none', !isEditMode);
            document.getElementById('viewContainer').classList.toggle('d-none', isEditMode);
            document.getElementById('editContainer').classList.toggle('d-none', !isEditMode);
            
            // Toggle GridStack CSS
            document.querySelector('link.edit-only').classList.toggle('d-none', !isEditMode);
            
            if (isEditMode) {
                initializeGrid();
                loadEditMode();
            }
        });
    });

    function loadViewMode() {
        const layout = {{ layout.config | safe }};
        const plotData = {{ plot_data | tojson | safe }};
        const container = document.getElementById('plotContainer');
        container.innerHTML = ''; // Clear existing content
        
        const plotDataMap = {};
        plotData.forEach(plot => plotDataMap[plot.plot_id] = plot);
        
        layout.forEach((item, index) => {
            const plotId = parseInt(item.plotId);
            if (plotId && plotDataMap[plotId]) {
                const plot = plotDataMap[plotId];
                const colClass = `col-md-${item.w}`;
                
                // Create column div
                const colDiv = document.createElement('div');
                colDiv.className = colClass;
                colDiv.style.marginBottom = '20px';
                
                // Create card div
                const cardDiv = document.createElement('div');
                cardDiv.className = 'card h-100';
                
                // Create plot container with specific height
                const plotDiv = document.createElement('div');
                plotDiv.id = `plot-${plotId}-${index}`;
                plotDiv.className = 'card-body d-flex plot-container';
                plotDiv.style.minHeight = '400px';  // Give it a minimum height
                
                cardDiv.appendChild(plotDiv);
                colDiv.appendChild(cardDiv);
                container.appendChild(colDiv);
                
                if (plot.plotly_json) {
                    const plotlyData = JSON.parse(plot.plotly_json);
                    plotlyData.layout = {
                        ...plotlyData.layout,
                        autosize: true,
                        height: null,
                        width: null,
                    };

                    Plotly.newPlot(plotDiv.id, 
                        plotlyData.data,
                        plotlyData.layout,
                        {
                            responsive: true,
                            displayModeBar: 'hover',
                            displaylogo: false,
                            modeBarButtonsToRemove: ['select2d', 'lasso2d', 'autoScale2d']
                        }
                    );

                    let resizeTimeout;
                    const observer = new ResizeObserver(() => {
                        clearTimeout(resizeTimeout);
                        resizeTimeout = setTimeout(() => {
                            Plotly.Plots.resize(plotDiv);
                        }, 100);
                    });
                    observer.observe(plotDiv.parentElement);
                }
            }
        });
    }

    function initializeGrid() {
        const gridConfig = {
            column: 12,
            cellHeight: 120,
            margin: 0,
            marginTop: 0,
            float: false,
            animate: true,
            draggable: {
                handle: '.grid-stack-item-content'
            }
        };

        gridConfig.disableResize = true;
        gridConfig.staticGrid = false;
        gridConfig.disableDrag = false;

        grid = GridStack.init(gridConfig, document.getElementById('editContainer').querySelector('.grid-stack'));
        grid.removeAll();

        // Add event delegation for remove widget buttons
        document.querySelector('.grid-stack').addEventListener('click', function(e) {
            if (e.target.closest('.remove-widget')) {
                const gridItem = e.target.closest('.grid-stack-item');
                grid.removeWidget(gridItem);
            }
        });
    }

    function loadEditMode() {
        const layout = {{ layout.config | safe }};
        
        layout.forEach(item => {
            const widget = {
                x: item.x,
                y: item.y,
                w: item.w,
                h: 1,
                content: `
                    <div class="widget-container">
                        <button class="btn btn-sm remove-widget" type="button">
                            <i class="fa fa-times"></i>
                        </button>
                        <select class="form-select plot-selector" onchange="plotSelected(this)">
                            <option value="">Select a plot...</option>
                            {% for plot in plots %}
                            <option value="{{ plot.id }}">{{ plot.name }}</option>
                            {% endfor %}
                        </select>
                    </div>`
            };
            
            requestAnimationFrame(() => {
                const el = grid.addWidget(widget);
                if (item.plotId) {
                    const select = el.querySelector('.plot-selector');
                    if (select) {
                        select.value = item.plotId;
                    }
                }
            });
        });
    }

    function addWidget(size) {
        const width = size === 'full' ? 12 : 6;
        const template = document.getElementById('widget-template');
        grid.addWidget({
            w: width,
            h: 1,
            content: template.innerHTML,
            autoPosition: true
        });
    }

    function saveLayout() {
        const serializedData = grid.save();
        const widgets = serializedData.map(item => {
            const gridItem = document.querySelector(`.grid-stack-item[gs-x="${item.x}"][gs-y="${item.y}"]`);
            const plotSelector = gridItem.querySelector('.plot-selector');
            return {
                gridItem,
                plotId: plotSelector?.value
            };
        });

        const unassignedWidgets = widgets.filter(w => !w.plotId);
        if (unassignedWidgets.length > 0) {
            alert(`Please select plots for all widgets before saving (${unassignedWidgets.length} unassigned)`);
            return;
        }

        const layoutData = {
            name: '{{ layout.name }}',
            config: serializedData.map((item, index) => ({
                x: item.x,
                y: item.y,
                w: item.w,
                h: 1,
                plotId: widgets[index].plotId
            }))
        };

        fetch('/{{ account.url }}/layout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(layoutData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.reload(); // Hard refresh after save
            } else {
                alert('Error saving layout: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error saving layout');
        });
    }
</script>
{% endblock %} 