{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <h2 class="mb-4">Data</h2>
    
    <!-- Flash Messages -->
    <div id="alertContainer" class="mb-4">
    </div>
    
    <!-- Device Filter Pills and Download Bar -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start mb-3 gap-3">
        <!-- Directory Filter and Download All -->
        <div class="d-flex align-items-center gap-2 w-100 w-md-auto">
            <div class="directory-filter flex-grow-1 flex-md-grow-0">
                <select class="form-select" id="directorySelect" onchange="window.location.href=this.value">
                    <option value="{{ url_for('accounts.account_data', account_url=account.url) }}" 
                            {{ 'selected' if not current_directory }}>
                        Recent
                    </option>
                    {% for directory in directories %}
                    <option value="{{ url_for('accounts.account_data', account_url=account.url, directory=directory) }}"
                            {{ 'selected' if current_directory == directory }}>
                        {{ directory }}/
                    </option>
                    {% endfor %}
                </select>
            </div>
            {% if current_directory %}
            <button class="btn btn-outline-primary btn-sm" onclick="downloadAllFiles('{{ current_directory }}')">
                Download All
            </button>
            {% endif %}
        </div>

        <!-- Download Selection Info -->
        <div class="download-selection d-flex flex-column flex-md-row align-items-end gap-2">
            <div class="d-flex gap-2 w-100">
                <span class="text-muted text-nowrap">
                    <span id="selectedCount">0</span> files selected
                    (<span id="selectedSize">0 B</span>)
                </span>
            </div>
            <div class="d-flex gap-1">
                <button class="btn btn-outline-secondary btn-sm text-nowrap" id="clearSelectionBtn" disabled>
                    Clear
                </button>
                <button class="btn btn-primary btn-sm text-nowrap" id="downloadSelectedBtn" disabled>
                    Download
                </button>
                {% if session.get('admin_id') %}
                <button class="btn btn-danger btn-sm text-nowrap" id="deleteSelectedBtn" disabled>
                    Delete
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Limit Notice and Legend -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="small">
            <span class="fileActive text-muted rounded px-2 py-1">checked &lt;30 min ago</span>
        </div>
        <p class="small text-muted mb-0">Page {{ pagination.page }} of {{ pagination.pages }}</p>
    </div>

    <!-- File Table -->
    <div class="row">
        <div class="col-12">
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 5%;"></th>
                        <th style="width: 65%;">Filename</th>
                        <th style="width: 15%;">Size</th>
                        <th style="width: 15%;">Last Modified</th>
                    </tr>
                </thead>
                <tbody>
                    {% if recent_files and recent_files|length > 0 %}
                    {% for file in recent_files %}
                    <tr data-key="{{ file.key }}">
                        <td>
                            <div class="form-check">
                                <input class="form-check-input file-select" type="checkbox" 
                                       data-id="{{ file.id }}"
                                       data-size="{{ file.size }}"
                                       data-key="{{ file.key }}">
                            </div>
                        </td>
                        <td>
                            <div class="d-flex justify-content-between align-items-start gap-2">
                                <span class="file-name text-break">{{ file.key }}</span>
                                <span class="badge border border-secondary text-secondary small fw-normal flex-shrink-0" role="button"
                                    onclick="showFileDetails(
                                        '{{ file.id }}',
                                        '{{ file.key | replace("'", "\\'") }}',
                                        '{{ file.size | filesizeformat }}',
                                        '{{ file.last_modified.isoformat() if file.last_modified else "" }}',
                                        '{{ file.version }}',
                                        '{{ file.last_checked.isoformat() if file.last_checked else " Never" }}')"
                                    style="cursor: pointer;">
                                    v{{ file.version }}
                                </span>
                            </div>
                        </td>
                        <td><small>{{ file.size | filesizeformat }}</small></td>
                        <td><small>{{ moment(file.last_modified | default('', true)).fromNow() | default('Never', true)
                                }}</small></td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="4" class="text-center">No recent data available.</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>

            <!-- Pagination -->
            {% if pagination.pages > 1 %}
            <nav aria-label="Page navigation" class="mt-4">
                <ul class="pagination justify-content-center">
                    <!-- Previous button -->
                    <li class="page-item {{ 'disabled' if not pagination.has_prev }}">
                        <a class="page-link" href="{{ url_for('accounts.account_data', 
                            account_url=account.url, 
                            directory=current_directory, 
                            page=pagination.prev_num) if pagination.has_prev else '#' }}">
                            Previous
                        </a>
                    </li>
                    
                    <!-- Page numbers -->
                    {% for page_num in pagination.iter_pages(left_edge=2, left_current=2, right_current=2, right_edge=2) %}
                        {% if page_num %}
                            <li class="page-item {{ 'active' if page_num == pagination.page }}">
                                <a class="page-link" href="{{ url_for('accounts.account_data', 
                                    account_url=account.url, 
                                    directory=current_directory, 
                                    page=page_num) }}">
                                    {{ page_num }}
                                </a>
                            </li>
                        {% else %}
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                        {% endif %}
                    {% endfor %}
                    
                    <!-- Next button -->
                    <li class="page-item {{ 'disabled' if not pagination.has_next }}">
                        <a class="page-link" href="{{ url_for('accounts.account_data', 
                            account_url=account.url, 
                            directory=current_directory, 
                            page=pagination.next_num) if pagination.has_next else '#' }}">
                            Next
                        </a>
                    </li>
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block modals %}
<!-- File Details Modal -->
<div class="modal fade" id="fileDetailsModal" tabindex="-1" aria-labelledby="fileDetailsModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="fileDetailsModalLabel">File Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <table class="table table-sm">
                    <tbody>
                        <tr>
                            <th scope="row">Filename</th>
                            <td id="modalFileName" class="text-break"></td>
                        </tr>
                        <tr>
                            <th scope="row">Size</th>
                            <td id="modalFileSize"></td>
                        </tr>
                        <tr>
                            <th scope="row">Version</th>
                            <td id="modalVersion"></td>
                        </tr>
                        <tr>
                            <th scope="row">Last Checked</th>
                            <td id="modalLastChecked"></td>
                        </tr>
                        <tr>
                            <th scope="row">Last Modified</th>
                            <td id="modalLastModified"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Download Progress Modal -->
<div class="modal fade" id="downloadProgressModal" tabindex="-1" aria-labelledby="downloadProgressModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5 class="mb-3">Preparing Download</h5>
                <p class="text-muted mb-0" id="downloadStatus">Compiling selected files...</p>
            </div>
        </div>
    </div>
</div>

<!-- Delete Progress Modal -->
<div class="modal fade" id="deleteProgressModal" tabindex="-1" aria-labelledby="deleteProgressModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5 class="mb-3">Deleting Files</h5>
                <p class="text-muted mb-0" id="deleteStatus">Processing selected files...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let selectedFiles = new Map();
    const ONE_GB = 1024 * 1024 * 1024;
    
    function updateSelectedFilesUI() {
        const selectedCount = document.getElementById('selectedCount');
        const selectedSize = document.getElementById('selectedSize');
        const downloadBtn = document.getElementById('downloadSelectedBtn');
        const clearBtn = document.getElementById('clearSelectionBtn');
        {% if session.get('admin_id') %}
        const deleteBtn = document.getElementById('deleteSelectedBtn');
        {% endif %}
        
        selectedCount.textContent = selectedFiles.size;
        
        // Calculate total size
        const totalSize = Array.from(selectedFiles.values())
            .reduce((sum, file) => sum + parseInt(file.size), 0);
        
        selectedSize.textContent = formatFileSize(totalSize);
        
        // Update button states
        clearBtn.disabled = selectedFiles.size === 0;
        downloadBtn.disabled = selectedFiles.size === 0 || totalSize > ONE_GB;
        {% if session.get('admin_id') %}
        deleteBtn.disabled = selectedFiles.size === 0;
        {% endif %}
        
        if (totalSize > ONE_GB) {
            downloadBtn.title = "File download exceeds 1GB. Please connect to your S3 bucket using API methods.";
        } else {
            downloadBtn.title = "";
        }
    }
    
    function formatFileSize(bytes) {
        const units = ['B', 'KB', 'MB', 'GB'];
        let size = bytes;
        let unitIndex = 0;
        
        while (size >= 1024 && unitIndex < units.length - 1) {
            size /= 1024;
            unitIndex++;
        }
        
        return `${Math.round(size * 100) / 100} ${units[unitIndex]}`;
    }
    
    // Handle checkbox changes
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('file-select')) {
            const fileId = e.target.dataset.id;
            
            if (e.target.checked) {
                selectedFiles.set(fileId, {
                    id: fileId,
                    key: e.target.dataset.key,
                    size: parseInt(e.target.dataset.size)
                });
            } else {
                selectedFiles.delete(fileId);
            }
            
            updateSelectedFilesUI();
        }
    });
    
    // Clear selection button
    document.getElementById('clearSelectionBtn').addEventListener('click', function() {
        selectedFiles.clear();
        document.querySelectorAll('.file-select').forEach(checkbox => {
            checkbox.checked = false;
        });
        updateSelectedFilesUI();
    });
    
    // Download selected files
    document.getElementById('downloadSelectedBtn').addEventListener('click', async function() {
        if (selectedFiles.size === 0) return;
        
        const fileIds = Array.from(selectedFiles.keys());
        
        // Only show progress modal for multiple files
        const progressModal = new bootstrap.Modal(document.getElementById('downloadProgressModal'));
        if (fileIds.length > 1) {
            progressModal.show();
        }
        
        try {
            const response = await fetch('{{ url_for("accounts.download_files", account_url=account.url) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ file_ids: fileIds })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Download failed');
            }
            
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            // Set filename based on number of files
            if (fileIds.length === 1) {
                const file = selectedFiles.get(fileIds[0]);
                a.download = file.key.split('/').pop();
            } else {
                const now = new Date();
                const timestamp = now.getFullYear().toString() +
                    (now.getMonth() + 1).toString().padStart(2, '0') +
                    now.getDate().toString().padStart(2, '0') +
                    now.getHours().toString().padStart(2, '0') +
                    now.getMinutes().toString().padStart(2, '0') +
                    now.getSeconds().toString().padStart(2, '0');
                a.download = `hublink_${timestamp}.zip`;
            }
            
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            // Ensure modal is hidden after successful download
            progressModal.hide();
            document.querySelector('.modal-backdrop')?.remove();
            document.body.classList.remove('modal-open');
        } catch (error) {
            document.getElementById('downloadStatus').textContent = error.message || 'Download failed. Please try again.';
            setTimeout(() => {
                progressModal.hide();
            }, 2000);
        }
    });

    {% if session.get('admin_id') %}
    // Delete selected files
    document.getElementById('deleteSelectedBtn').addEventListener('click', async function() {
        if (selectedFiles.size === 0) return;
        
        if (!confirm('Are you sure you want to delete these files? This action cannot be undone.')) {
            return;
        }
        
        const fileIds = Array.from(selectedFiles.keys());
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteProgressModal'));
        deleteModal.show();
        
        try {
            const response = await fetch('{{ url_for("accounts.delete_files", account_url=account.url) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    file_ids: fileIds,
                    directory: '{{ current_directory }}'
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Delete failed');
            }
            
            const data = await response.json();
            
            // Immediately redirect or refresh
            if (data.redirect) {
                window.location.href = data.redirect;
            } else {
                window.location.reload();
            }
            
        } catch (error) {
            // Hide the modal
            deleteModal.hide();
            document.querySelector('.modal-backdrop')?.remove();
            document.body.classList.remove('modal-open');
            
            // Show error in alert
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.innerHTML = `
                ${error.message || 'Delete failed. Please try again.'}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.getElementById('alertContainer').appendChild(alertDiv);
        }
    });
    {% endif %}

    function updateActiveFiles() {
        fetch('{{ url_for("accounts.get_recent_checks", account_url=account.url) }}')
            .then(response => response.json())
            .then(data => {
                document.querySelectorAll('tr.fileActive').forEach(el => {
                    el.classList.remove('fileActive');
                });

                data.recent_files.forEach(fileKey => {
                    const fileRow = document.querySelector(`tr[data-key="${fileKey}"]`);
                    if (fileRow) {
                        fileRow.classList.add('fileActive');
                    }
                });
            })
            .catch(error => console.error('Error:', error));
    }

    updateActiveFiles();
    setInterval(updateActiveFiles, 60000);

    function showFileDetails(fileId, fileName, fileSize, lastModified, version, lastChecked) {
        document.getElementById('modalFileName').textContent = fileName;
        document.getElementById('modalFileSize').textContent = fileSize;
        document.getElementById('modalLastModified').textContent = lastModified ?
            moment.utc(lastModified).local().format('LLL') : 'Never';
        document.getElementById('modalVersion').textContent = 'v' + version;
        document.getElementById('modalLastChecked').textContent = lastChecked === ' Never' ?
            'Never' : moment.utc(lastChecked).local().format('LLL');

        const modal = new bootstrap.Modal(document.getElementById('fileDetailsModal'));
        modal.show();
    }

    document.addEventListener('DOMContentLoaded', function() {
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            modal.classList.remove('show');
            modal.removeAttribute('style');
            modal.removeAttribute('aria-modal');
            modal.setAttribute('aria-hidden', 'true');
        });
    });

    async function downloadAllFiles(directory) {
        const progressModal = new bootstrap.Modal(document.getElementById('downloadProgressModal'));
        progressModal.show();
        
        try {
            const response = await fetch('{{ url_for("accounts.download_files", account_url=account.url) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ directory: directory })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Download failed');
            }
            
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            // Generate timestamp for zip filename
            const now = new Date();
            const timestamp = now.getFullYear().toString() +
                (now.getMonth() + 1).toString().padStart(2, '0') +
                now.getDate().toString().padStart(2, '0') +
                now.getHours().toString().padStart(2, '0') +
                now.getMinutes().toString().padStart(2, '0') +
                now.getSeconds().toString().padStart(2, '0');
            a.download = `hublink_${timestamp}.zip`;
            
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            // Ensure modal is hidden after successful download
            progressModal.hide();
            document.querySelector('.modal-backdrop')?.remove();
            document.body.classList.remove('modal-open');
        } catch (error) {
            document.getElementById('downloadStatus').textContent = error.message || 'Download failed. Please try again.';
            setTimeout(() => {
                progressModal.hide();
            }, 2000);
        }
    }
</script>
{% endblock %}